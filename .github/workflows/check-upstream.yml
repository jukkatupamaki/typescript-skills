name: Check Upstream TypeScript Docs

on:
  schedule:
    - cron: "0 9 * * 1" # Every Monday at 9 AM UTC
  workflow_dispatch:

jobs:
  check:
    name: Detect Drift
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/checkout@v4
        with:
          repository: microsoft/TypeScript-Website
          path: TypeScript-Website

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm ci

      - name: Check for drift
        id: drift
        run: |
          set +e
          npx tsx build/src/index.ts --check 2>&1 | tee drift-report.txt
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Get upstream commit
        if: steps.drift.outputs.exit_code == '1'
        id: upstream
        run: |
          cd TypeScript-Website
          echo "commit=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Create issue if drift detected
        if: steps.drift.outputs.exit_code == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('drift-report.txt', 'utf-8');

            // Check for existing open issue
            const existing = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'upstream-update',
              state: 'open',
            });

            if (existing.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.data[0].number,
                body: `## Updated Drift Report (${new Date().toISOString().slice(0, 10)})\n\nUpstream commit: \`${{ steps.upstream.outputs.commit }}\`\n\n\`\`\`\n${report}\n\`\`\``,
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `TypeScript docs upstream changes detected (${new Date().toISOString().slice(0, 10)})`,
                body: `## Drift Report\n\nUpstream commit: \`${{ steps.upstream.outputs.commit }}\`\n\n\`\`\`\n${report}\n\`\`\`\n\n### To rebuild\n\n\`\`\`bash\n# Update the docs repo\ncd TypeScript-Website && git pull\n\n# Rebuild the skill\nnpx tsx build/src/index.ts --build\n\n# Run tests\nnpx vitest run test/structural/\n\`\`\`\n\nOr trigger the **Rebuild TypeScript Skill** workflow manually.`,
                labels: ['upstream-update'],
              });
            }
